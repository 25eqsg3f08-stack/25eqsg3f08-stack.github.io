name: 仓库全拦截（仅授权+站点公开）
on:
  # 覆盖所有仓库访问场景，无遗漏
  push: { branches: ['*'] }
  pull_request: { branches: ['*'] }
  pull_request_target: { branches: ['*'] }  # 核心：拦截仓库浏览/下载
  workflow_dispatch:
  repository_dispatch:
  create: { branches: ['*'] }  # 拦截创建分支
  delete: { branches: ['*'] }  # 拦截删除分支
  issues: { types: [opened, edited, closed] }  # 拦截issues操作
  release: { types: [published, edited] }  # 拦截发布操作

jobs:
  full-repo-protect:
    runs-on: ubuntu-latest
    steps:
      - name: 严格身份校验（阻断所有非法访问）
        run: |
          ALLOWED_USERS=("25eqsg3f08-stack")  # 仅你授权，无需修改
          
          # 匿名用户直接拒
          if [[ -z "${GITHUB_ACTOR}" ]]; then
            echo "❌ 匿名访问被拒绝！仓库仅授权用户可见。"
            exit 1
          fi
          # 非白名单用户直接拒
          if [[ ! " ${ALLOWED_USERS[@]} " =~ " ${GITHUB_ACTOR} " ]]; then
            echo "❌ 未授权访问被拒绝！"
            exit 1
          fi
          echo "✅ 授权用户，操作放行～"

      - name: 拉取代码（仅授权用户）
        if: success()
        uses: actions/checkout@v4

      - name: 公开部署站点
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./